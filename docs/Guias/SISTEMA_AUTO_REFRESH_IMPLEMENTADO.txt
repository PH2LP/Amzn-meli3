# âœ… Sistema de RenovaciÃ³n AutomÃ¡tica de Tokens - IMPLEMENTADO

## ğŸ¯ Objetivo Cumplido

ImplementaciÃ³n completa de un sistema automÃ¡tico que renueva los tokens de Amazon y MercadoLibre sin intervenciÃ³n manual.

---

## ğŸ“¦ Lo que se ImplementÃ³

### ğŸŸ  Amazon SP-API: CachÃ© Inteligente On-Demand

**Archivo modificado**: `src/integrations/amazon_api.py`

**CÃ³mo funciona**:
1. Cuando cualquier script llama `get_amazon_access_token()`:
   - Verifica si existe un token en `cache/amazon_token.json`
   - Si el token tiene menos de 55 minutos â†’ lo reutiliza
   - Si no existe o expirÃ³ â†’ genera uno nuevo automÃ¡ticamente y lo guarda

2. **Ventajas**:
   - âœ… Cero procesos en background (no consume recursos cuando no se usa)
   - âœ… Eficiente (reutiliza tokens vÃ¡lidos)
   - âœ… Completamente automÃ¡tico
   - âœ… Transparente (scripts existentes funcionan sin cambios)

**Ejemplo de uso**:
```python
from src.integrations.amazon_api import get_product_data_from_asin

# Primera vez: genera token y lo cachea (55 min)
data = get_product_data_from_asin("B0CYM126TT")

# Siguientes llamadas: reutiliza el token cacheado
data2 = get_product_data_from_asin("B0DRW8G3WK")  # â™»ï¸ Usa cachÃ©
```

**Output**:
```
ğŸ” Generando nuevo access token de Amazon...
âœ… Token generado y cacheado (vÃ¡lido por 55 min)
```

Siguiente llamada:
```
â™»ï¸ Usando token cacheado de Amazon (vÃ¡lido por 42 min mÃ¡s)
```

---

### ğŸ”µ MercadoLibre: Loop AutomÃ¡tico Continuo

**Archivos creados**:
```
scripts/auth/
â”œâ”€â”€ ml_token_loop.py                      # Script principal del loop
â”œâ”€â”€ ml_token_loop.sh                       # Wrapper bash
â”œâ”€â”€ com.revancha.ml_token_refresh.plist    # ConfiguraciÃ³n LaunchAgent (macOS)
â”œâ”€â”€ install_ml_token_service.sh            # Instalador automÃ¡tico
â””â”€â”€ auto_refresh_token.py                  # Script manual legacy (mantenido)

docs/
â””â”€â”€ TOKEN_AUTO_REFRESH_README.md           # DocumentaciÃ³n completa

root/
â””â”€â”€ INSTALAR_TOKEN_AUTO_REFRESH.sh         # Instalador interactivo
```

**CÃ³mo funciona**:
1. Loop continuo que se ejecuta cada 5.5 horas (tokens de ML duran 6 horas)
2. Renueva el token automÃ¡ticamente usando la API de ML
3. Actualiza el archivo `.env` con el nuevo token
4. Se ejecuta como servicio del sistema (LaunchAgent en macOS)
5. Logs completos de cada renovaciÃ³n

**Ventajas**:
- âœ… Siempre activo (necesario porque ML puede recibir ventas/preguntas 24/7)
- âœ… Auto-recuperable (se reinicia si falla)
- âœ… Persistente (se ejecuta al iniciar el sistema)
- âœ… Actualiza .env automÃ¡ticamente
- âœ… Logs detallados

**InstalaciÃ³n**:
```bash
./INSTALAR_TOKEN_AUTO_REFRESH.sh
```

O manual:
```bash
./scripts/auth/install_ml_token_service.sh
```

**Verificar status**:
```bash
launchctl list | grep ml_token
```

**Ver logs**:
```bash
tail -f logs/ml_token_refresh.log
```

**Output del log**:
```
[2025-11-08 14:26:07] ğŸš€ Iniciando loop automÃ¡tico de renovaciÃ³n ML Token
[2025-11-08 14:26:07]    Intervalo: 5.5 horas (19800.0 segundos)
[2025-11-08 14:26:07] ğŸ”„ Renovando access token de MercadoLibre...
[2025-11-08 14:26:08] âœ… Token renovado exitosamente
[2025-11-08 14:26:08]    Access token: APP_USR-1758699366225963-110815-aca30aed...
[2025-11-08 14:26:08]    PrÃ³xima renovaciÃ³n en 5.5 horas
[2025-11-08 14:26:08] â³ Esperando 5.5 horas hasta prÃ³xima renovaciÃ³n... (iteraciÃ³n #1)
```

---

## ğŸ§ª Pruebas Realizadas

### âœ… Test 1: Amazon CachÃ©

```bash
python3 -c "from src.integrations.amazon_api import get_amazon_access_token; ..."
```

**Resultado**:
```
ğŸ§ª Test 1: Generando primer token de Amazon...
ğŸ” Generando nuevo access token de Amazon...
âœ… Token generado y cacheado (vÃ¡lido por 55 min)

ğŸ§ª Test 2: Intentando obtener token nuevamente (deberÃ­a usar cachÃ©)...
â™»ï¸ Usando token cacheado de Amazon (vÃ¡lido por 54 min mÃ¡s)

âœ… Ã‰XITO: Ambos tokens son iguales (cachÃ© funcionando correctamente)
```

### âœ… Test 2: MercadoLibre Loop

```bash
python3 scripts/auth/ml_token_loop.py
```

**Resultado**:
```
ğŸš€ Loop de ML iniciado con PID: 59389
âœ… Loop corriendo correctamente
[2025-11-08 14:26:08] âœ… Token renovado exitosamente
```

**VerificaciÃ³n en .env**:
```bash
grep "ML_ACCESS_TOKEN=" .env
# ML_ACCESS_TOKEN=APP_USR-1758699366225963-110815-aca30aeda463aaea3f262d6d9ad71b40-2629793984
```
âœ… Token actualizado correctamente

---

## ğŸ“‹ Resumen de Frecuencias

| Token | DuraciÃ³n Real | RenovaciÃ³n | MÃ©todo |
|-------|---------------|------------|--------|
| **Amazon SP-API** | 1 hora (3600 seg) | A los 55 min | CachÃ© on-demand |
| **MercadoLibre** | 6 horas | Cada 5.5 horas | Loop continuo |

---

## ğŸš€ Uso

### Para Amazon

**No requiere acciÃ³n**. Simplemente usa tus scripts normalmente:

```python
# En cualquier script
from src.integrations.amazon_api import get_product_data_from_asin
data = get_product_data_from_asin("B0CYM126TT")
# El token se renueva automÃ¡ticamente si es necesario
```

### Para MercadoLibre

**OpciÃ³n 1: InstalaciÃ³n como servicio (RECOMENDADO)**
```bash
# Solo una vez:
./INSTALAR_TOKEN_AUTO_REFRESH.sh

# Ya no necesitas hacer nada mÃ¡s, el servicio corre automÃ¡ticamente
```

**OpciÃ³n 2: Ejecutar manualmente**
```bash
# En una terminal:
./scripts/auth/ml_token_loop.sh

# O en background:
nohup ./scripts/auth/ml_token_loop.sh > /dev/null 2>&1 &
```

---

## ğŸ“Š Comandos Ãštiles

### Amazon

```bash
# Ver cache actual
cat cache/amazon_token.json

# Ver edad del token
ls -lh cache/amazon_token.json
```

### MercadoLibre

```bash
# Ver status del servicio
launchctl list | grep ml_token

# Ver logs en tiempo real
tail -f logs/ml_token_refresh.log

# Detener servicio
launchctl unload ~/Library/LaunchAgents/com.revancha.ml_token_refresh.plist

# Iniciar servicio
launchctl load ~/Library/LaunchAgents/com.revancha.ml_token_refresh.plist

# Verificar token actual en .env
grep "ML_ACCESS_TOKEN=" .env
```

---

## ğŸ“š DocumentaciÃ³n

DocumentaciÃ³n completa disponible en:
```bash
cat docs/TOKEN_AUTO_REFRESH_README.md
```

Incluye:
- CÃ³mo funciona cada sistema
- InstalaciÃ³n paso a paso
- Troubleshooting
- Comandos Ãºtiles
- ExplicaciÃ³n de logs

---

## ğŸ‰ Resultado Final

### Antes
- âŒ TenÃ­as que renovar tokens manualmente cada hora (Amazon) y cada 6 horas (ML)
- âŒ Scripts fallaban cuando los tokens expiraban
- âŒ TenÃ­as que recordar ejecutar scripts de renovaciÃ³n

### Ahora
- âœ… **Amazon**: Se renueva automÃ¡ticamente cuando usas la API (cachÃ© de 55 min)
- âœ… **MercadoLibre**: Se renueva automÃ¡ticamente cada 5.5 horas (loop continuo)
- âœ… **Cero intervenciÃ³n manual**
- âœ… **Logs completos** para monitorear
- âœ… **Auto-recuperable** si algo falla
- âœ… **Persistente** (se ejecuta al iniciar el sistema)

**Nunca mÃ¡s tendrÃ¡s que preocuparte por los tokens. Todo es automÃ¡tico.**
