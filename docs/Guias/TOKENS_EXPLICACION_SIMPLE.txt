# ğŸ”‘ Tokens AutomÃ¡ticos - ExplicaciÃ³n Simple

## Â¿QuÃ© se instalÃ³?

Un sistema que **renueva automÃ¡ticamente** los tokens de Amazon y MercadoLibre para que nunca expiren.

---

## ğŸŸ  Amazon (Ya Funciona)

**Â¿QuÃ© hace?**
- Genera un token cuando lo necesitas
- Lo guarda por 55 minutos
- Si lo vuelves a necesitar antes de 55 minutos, reutiliza el mismo

**Â¿Tengo que hacer algo?**
- **NO**. Ya estÃ¡ integrado en `amazon_api.py`
- Tus scripts funcionan igual que antes, pero ahora no fallan por token expirado

**Â¿CÃ³mo lo veo funcionando?**
Cuando uses cualquier script que llame a Amazon verÃ¡s:

Primera vez:
```
ğŸ” Generando nuevo access token de Amazon...
âœ… Token generado y cacheado (vÃ¡lido por 55 min)
```

Siguiente vez (antes de 55 min):
```
â™»ï¸ Usando token cacheado de Amazon (vÃ¡lido por 42 min mÃ¡s)
```

---

## ğŸ”µ MercadoLibre (Instalado Ahora)

**Â¿QuÃ© hace?**
- Renueva el token **cada 5.5 horas** automÃ¡ticamente
- Corre en background (no lo ves, pero estÃ¡ ahÃ­)
- Actualiza el archivo `.env` con el nuevo token
- Se inicia automÃ¡ticamente cuando prendes la Mac

**Â¿Tengo que hacer algo?**
- **NO**. Ya quedÃ³ instalado como servicio
- Cada vez que prendas la Mac, se inicia automÃ¡ticamente
- No necesitas ejecutar nada manualmente

**Â¿CÃ³mo sÃ© que estÃ¡ funcionando?**

Ver si estÃ¡ corriendo:
```bash
launchctl list | grep ml_token
```

DeberÃ­a mostrar algo como:
```
-    126    com.revancha.ml_token_refresh
```

Ver el log en tiempo real:
```bash
tail -f logs/ml_token_refresh.log
```

VerÃ¡s algo como:
```
[2025-11-08 14:26:08] âœ… Token renovado exitosamente
[2025-11-08 14:26:08]    PrÃ³xima renovaciÃ³n en 5.5 horas
[2025-11-08 14:26:08] â³ Esperando 5.5 horas hasta prÃ³xima renovaciÃ³n... (iteraciÃ³n #1)
```

---

## ğŸ“… Frecuencia de RenovaciÃ³n

| Plataforma | Token dura | Se renueva | MÃ©todo |
|------------|------------|------------|--------|
| Amazon | 1 hora | A los 55 min (automÃ¡tico cuando se usa) | CachÃ© inteligente |
| MercadoLibre | 6 horas | Cada 5.5 horas (siempre activo) | Loop en background |

---

## â“ Preguntas Frecuentes

### Â¿Y si reinicio la Mac?

**MercadoLibre**: Se inicia automÃ¡ticamente al prender la Mac
**Amazon**: Genera el token cuando lo necesites (no necesita estar corriendo)

### Â¿CÃ³mo veo si el token de ML estÃ¡ actualizado?

```bash
grep "ML_ACCESS_TOKEN=" .env
```

VerÃ¡s el token actual. Si ves que tiene fecha/hora reciente en el log, estÃ¡ actualizado.

### Â¿Y si falla la renovaciÃ³n?

El servicio:
1. Lo reintenta automÃ¡ticamente
2. Escribe el error en el log
3. Sigue intentando cada 5.5 horas

Puedes ver errores en:
```bash
tail -f logs/ml_token_refresh_stderr.log
```

### Â¿CÃ³mo detengo el servicio de ML?

```bash
launchctl unload ~/Library/LaunchAgents/com.revancha.ml_token_refresh.plist
```

Para iniciarlo de nuevo:
```bash
launchctl load ~/Library/LaunchAgents/com.revancha.ml_token_refresh.plist
```

### Â¿DÃ³nde estÃ¡n los archivos del sistema?

```
src/integrations/
â””â”€â”€ amazon_api.py                          â† CachÃ© de Amazon integrado aquÃ­

scripts/auth/
â”œâ”€â”€ ml_token_loop.py                       â† Loop principal de ML
â”œâ”€â”€ ml_token_loop.sh                       â† Script de inicio
â””â”€â”€ install_ml_token_service.sh            â† Instalador

~/Library/LaunchAgents/
â””â”€â”€ com.revancha.ml_token_refresh.plist    â† Servicio instalado (macOS)

logs/
â”œâ”€â”€ ml_token_refresh.log                   â† Log principal de ML
â”œâ”€â”€ ml_token_refresh_stdout.log            â† Output estÃ¡ndar
â””â”€â”€ ml_token_refresh_stderr.log            â† Errores

cache/
â””â”€â”€ amazon_token.json                      â† Token de Amazon cacheado
```

---

## âœ… Resumen

### Antes
- Tokens expiraban cada hora (Amazon) y cada 6 horas (ML)
- TenÃ­as que renovarlos manualmente
- Scripts fallaban cuando expiraban

### Ahora
- **Amazon**: Se renueva solo cuando lo usas (cachÃ© de 55 min)
- **MercadoLibre**: Se renueva automÃ¡ticamente cada 5.5 horas en background
- **No necesitas hacer nada**
- Los scripts nunca fallan por tokens expirados

---

## ğŸ†˜ Si Algo No Funciona

1. **Verificar que el servicio de ML estÃ¡ corriendo**:
   ```bash
   launchctl list | grep ml_token
   ```

2. **Ver el log de ML**:
   ```bash
   tail -50 logs/ml_token_refresh.log
   ```

3. **Ver errores**:
   ```bash
   tail -50 logs/ml_token_refresh_stderr.log
   ```

4. **Reinstalar el servicio**:
   ```bash
   ./scripts/auth/install_ml_token_service.sh
   ```

5. **Ver cachÃ© de Amazon**:
   ```bash
   cat cache/amazon_token.json
   ```

---

## ğŸ“š DocumentaciÃ³n Completa

Para mÃ¡s detalles tÃ©cnicos:
```bash
cat docs/TOKEN_AUTO_REFRESH_README.md
```

Para ver un resumen de la implementaciÃ³n:
```bash
cat SISTEMA_AUTO_REFRESH_IMPLEMENTADO.md
```

---

**ğŸ‰ Â¡Listo! Ya no tienes que preocuparte por los tokens nunca mÃ¡s.**
