# ğŸ“˜ GuÃ­a de Uso Completa - Amazon â†’ MercadoLibre Pipeline

GuÃ­a completa para usar todos los mÃ³dulos del sistema de sincronizaciÃ³n Amazon â†’ MercadoLibre.

---

## ğŸ“‹ Tabla de Contenidos

1. [Pipeline Principal (main2.py)](#1-pipeline-principal-main2py)
2. [Sistema de Respuestas AutomÃ¡ticas](#2-sistema-de-respuestas-automÃ¡ticas)
3. [SincronizaciÃ³n Amazon-ML](#3-sincronizaciÃ³n-amazon-ml)
4. [Scripts de AutenticaciÃ³n](#4-scripts-de-autenticaciÃ³n)
5. [Estructura del Proyecto](#5-estructura-del-proyecto)

---

## 1. Pipeline Principal (main2.py)

### ğŸ¯ DescripciÃ³n
Pipeline principal que transforma productos de Amazon en publicaciones de MercadoLibre usando IA y embeddings.

### ğŸš€ Uso BÃ¡sico

```bash
# Procesar todos los ASINs en data/asins.txt
python3 main2.py

# Procesar un ASIN especÃ­fico
python3 main2.py --asin B0F2MJ5H6V

# SimulaciÃ³n sin publicar (dry-run)
python3 main2.py --dry-run

# Con validaciÃ³n IA activada
python3 main2.py --enable-validation

# Forzar regeneraciÃ³n de archivos existentes
python3 main2.py --force-regenerate

# Saltar verificaciones de salud
python3 main2.py --skip-health-check
```

### ğŸ“ Opciones Disponibles

| OpciÃ³n | DescripciÃ³n |
|--------|-------------|
| `--asin ASIN` | Procesar solo un ASIN especÃ­fico |
| `--asins-file FILE` | Archivo con lista de ASINs (default: data/asins.txt) |
| `--dry-run` | Simular publicaciones sin enviar a ML |
| `--enable-validation` | Activar validaciÃ³n IA (desactivada por defecto) |
| `--force-regenerate` | Forzar regeneraciÃ³n de archivos existentes |
| `--skip-health-check` | Saltar verificaciones de salud |

### ğŸ“‚ Archivos de Entrada

- **data/asins.txt**: Lista de ASINs a procesar (uno por lÃ­nea)

### ğŸ“¤ Archivos de Salida

- **storage/asins_json/**: JSONs descargados de Amazon
- **storage/logs/publish_ready/**: JSONs transformados listos para publicar
- **storage/logs/pipeline/**: Reportes de ejecuciÃ³n
- **storage/pipeline_state.db**: Base de datos de estado

### ğŸ” Monitorear EjecuciÃ³n en Vivo

```bash
# En otra terminal
tail -f storage/logs/pipeline/report_YYYYMMDD_HHMMSS.json
```

### âš¡ CaracterÃ­sticas Principales

- **DetecciÃ³n Inteligente de CategorÃ­as**: Embeddings + IA (CategoryMatcherV2)
- **Sistema de Reintentos**: Hasta 8 intentos con categorÃ­as alternativas
- **PublicaciÃ³n Multi-PaÃ­s**: MLC, MLM, MCO, MLB, MLA
- **Descripciones Optimizadas**: Title Case, sin emojis, formato profesional
- **ValidaciÃ³n AutomÃ¡tica**: Checks de completitud y consistencia

---

## 2. Sistema de Respuestas AutomÃ¡ticas

### ğŸ¯ DescripciÃ³n
Sistema que responde automÃ¡ticamente preguntas de clientes en MercadoLibre usando:
- Templates predefinidos (0 tokens)
- Cache de respuestas similares (0 tokens)
- IA solo cuando es necesario (~150 tokens)

### ğŸš€ EjecuciÃ³n Manual (Una Vez)

```bash
python3 scripts/tools/auto_answer_questions.py
```

### ğŸ”„ EjecuciÃ³n Continua (Loop)

```bash
# Ejecutar en background
./scripts/tools/auto_responder_loop.sh

# Ver output en vivo
tail -f logs/auto_answer.log
```

### â±ï¸ Funcionamiento

- Revisa preguntas cada **60 segundos**
- Responde automÃ¡ticamente usando templates o IA
- Guarda respuestas en cache para reutilizaciÃ³n
- Log detallado de cada respuesta enviada

### ğŸ“Š Ahorro de Tokens

- **Templates genÃ©ricos**: 0 tokens (95% de preguntas)
- **Cache de respuestas**: 0 tokens
- **IA solo cuando necesario**: ~150 tokens (5% de preguntas)

### ğŸ“ Templates Disponibles

El sistema incluye 20+ templates genÃ©ricos en espaÃ±ol e inglÃ©s para:
- Preguntas sobre stock/disponibilidad
- Consultas de envÃ­o
- Preguntas de precio
- GarantÃ­as y devoluciones
- CaracterÃ­sticas del producto

**UbicaciÃ³n**: `docs/questions/generic_qa.json`

### ğŸ› ï¸ ConfiguraciÃ³n

Edita los mensajes de saludo/despedida en:
```python
# scripts/tools/auto_answer_questions.py
CUSTOM_GREETING = "Â¡Hola! Gracias por tu consulta."
CUSTOM_FAREWELL = "Â¡Saludos!"
```

### ğŸ“ Base de Datos

- **storage/listings_database.db**: InformaciÃ³n de productos y cache de respuestas

---

## 3. SincronizaciÃ³n Amazon-ML

### ğŸ¯ DescripciÃ³n
Sincroniza automÃ¡ticamente productos de Amazon con MercadoLibre, actualizando:
- Stock/disponibilidad
- Precios
- CaracterÃ­sticas del producto

### ğŸš€ EjecuciÃ³n Manual

```bash
python3 scripts/tools/sync_amazon_ml.py
```

### â° Configurar Cron Job (AutomÃ¡tico)

```bash
# Ejecutar script de configuraciÃ³n
./scripts/tools/setup_sync_cron.sh

# El cron job se ejecutarÃ¡:
# - Cada 3 dÃ­as
# - A las 9:00 AM
# - Logs en: logs/sync/sync_cron.log
```

### ğŸ“‹ Verificar Cron Job Instalado

```bash
crontab -l | grep sync_amazon_ml
```

### ğŸ”§ Personalizar Frecuencia

Edita `scripts/tools/setup_sync_cron.sh`:

```bash
# LÃ­nea 44 - Cambiar frecuencia
# Formato: MIN HOUR DAY MONTH WEEKDAY

# Cada dÃ­a a las 9:00 AM
CRON_LINE="0 9 * * * cd $PROJECT_DIR && ..."

# Cada 12 horas
CRON_LINE="0 */12 * * * cd $PROJECT_DIR && ..."

# Cada lunes a las 10:00 AM
CRON_LINE="0 10 * * 1 cd $PROJECT_DIR && ..."
```

### ğŸ“Š Logs

```bash
# Ver logs de sincronizaciÃ³n
tail -f logs/sync/sync_cron.log

# Ver Ãºltimo sync
tail -50 logs/sync/sync_cron.log
```

### ğŸ“˜ DocumentaciÃ³n Adicional

Ver: `docs/QUICKSTART_SYNC.md` y `docs/SYNC_AMAZON_ML_README.md`

---

## 4. Scripts de AutenticaciÃ³n

### ğŸ” RenovaciÃ³n de Tokens

Los tokens se renuevan automÃ¡ticamente, pero tambiÃ©n puedes hacerlo manualmente:

#### MercadoLibre

```bash
python3 scripts/auth/auto_refresh_token.py
```

#### Amazon SP-API

```bash
python3 scripts/auth/auto_refresh_token_amzn.py
```

### ğŸ”‘ ConfiguraciÃ³n de Credenciales

Todas las credenciales se configuran en `.env`:

```env
# MercadoLibre
ML_CLIENT_ID=tu_client_id
ML_CLIENT_SECRET=tu_client_secret
ML_REFRESH_TOKEN=tu_refresh_token

# Amazon SP-API
SP_API_REFRESH_TOKEN=tu_refresh_token
LWA_CLIENT_ID=tu_client_id
LWA_CLIENT_SECRET=tu_client_secret

# OpenAI (para IA)
OPENAI_API_KEY=tu_api_key
```

---

## 5. Estructura del Proyecto

### ğŸ“ Directorio RaÃ­z

```
revancha/
â”œâ”€â”€ main2.py                    # â­ Script principal del pipeline
â”œâ”€â”€ .env                        # Credenciales (NO commitear)
â”œâ”€â”€ requirements.txt            # Dependencias Python
â”‚
â”œâ”€â”€ src/                        # CÃ³digo fuente
â”‚   â”œâ”€â”€ pipeline/               # LÃ³gica core
â”‚   â”œâ”€â”€ integrations/           # APIs externas
â”‚   â””â”€â”€ utils/                  # Utilidades
â”‚
â”œâ”€â”€ data/                       # Datos y recursos
â”‚   â”œâ”€â”€ asins.txt               # Lista de ASINs
â”‚   â”œâ”€â”€ categories/             # CategorÃ­as ML
â”‚   â””â”€â”€ schemas/                # Schemas CBT
â”‚
â”œâ”€â”€ scripts/                    # Scripts auxiliares
â”‚   â”œâ”€â”€ auth/                   # RenovaciÃ³n de tokens
â”‚   â””â”€â”€ tools/                  # Herramientas
â”‚
â”œâ”€â”€ storage/                    # Bases de datos
â”‚   â”œâ”€â”€ listings_database.db    # Productos y cache
â”‚   â”œâ”€â”€ pipeline_state.db       # Estado del pipeline
â”‚   â”œâ”€â”€ asins_json/             # JSONs de Amazon
â”‚   â””â”€â”€ logs/                   # Logs de ejecuciÃ³n
â”‚
â”œâ”€â”€ docs/                       # DocumentaciÃ³n
â””â”€â”€ logs/                       # Logs generales
```

### ğŸ—‚ï¸ Archivos Importantes

| Archivo | DescripciÃ³n |
|---------|-------------|
| `main2.py` | Pipeline principal |
| `data/asins.txt` | Lista de ASINs a procesar |
| `.env` | Credenciales (PRIVADO) |
| `storage/pipeline_state.db` | Estado del pipeline |
| `storage/listings_database.db` | Cache y productos |

---

## ğŸš€ Flujo de Trabajo TÃ­pico

### 1. Agregar Productos Nuevos

```bash
# 1. Editar lista de ASINs
nano data/asins.txt

# 2. Agregar ASINs (uno por lÃ­nea)
B0F2MJ5H6V
B07LBQR3QY

# 3. Ejecutar pipeline
python3 main2.py
```

### 2. Monitorear Sistema

```bash
# Ver logs del pipeline
tail -f storage/logs/pipeline/report_*.json

# Ver respuestas automÃ¡ticas
tail -f logs/auto_answer.log

# Ver sincronizaciÃ³n
tail -f logs/sync/sync_cron.log
```

### 3. ConfiguraciÃ³n Inicial

```bash
# 1. Configurar credenciales
cp .env.example .env
nano .env

# 2. Instalar dependencias
pip install -r requirements.txt

# 3. Configurar auto-responder (opcional)
./scripts/tools/auto_responder_loop.sh &

# 4. Configurar sincronizaciÃ³n (opcional)
./scripts/tools/setup_sync_cron.sh
```

---

## âš ï¸ SoluciÃ³n de Problemas

### Pipeline no encuentra archivos

```bash
# Verificar rutas
python3 main2.py --help

# DeberÃ­a mostrar: data/asins.txt
```

### Error de imports

```bash
# Verificar estructura de carpetas
ls -la src/pipeline/
ls -la src/integrations/

# Reinstalar dependencias
pip install -r requirements.txt
```

### Tokens expirados

```bash
# Renovar token ML
python3 scripts/auth/auto_refresh_token.py

# Renovar token Amazon
python3 scripts/auth/auto_refresh_token_amzn.py
```

### Auto-responder no funciona

```bash
# Verificar que existe la base de datos
ls -lh storage/listings_database.db

# Ejecutar manualmente para ver errores
python3 scripts/tools/auto_answer_questions.py
```

---

## ğŸ“ Soporte

- **DocumentaciÃ³n adicional**: Ver carpeta `docs/`
- **Logs**: Revisar `storage/logs/` y `logs/`
- **Estado del sistema**: Verificar `storage/pipeline_state.db`

---

## ğŸ¯ Mejores PrÃ¡cticas

1. **Siempre usa dry-run primero**: `python3 main2.py --dry-run`
2. **Revisa logs regularmente**: `tail -f storage/logs/pipeline/*.json`
3. **MantÃ©n credenciales seguras**: Nunca commitear `.env`
4. **Usa el sistema de reintentos**: El pipeline intenta hasta 8 veces
5. **Monitorea respuestas automÃ¡ticas**: Verifica que sean apropiadas

---

**Ãšltima actualizaciÃ³n**: Noviembre 2025
**VersiÃ³n del sistema**: v2.0 - Estructura Modular
