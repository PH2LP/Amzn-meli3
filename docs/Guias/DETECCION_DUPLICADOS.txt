# ğŸ” Sistema de DetecciÃ³n de Duplicados

Sistema inteligente que previene reprocesar y republicar productos que ya estÃ¡n en MercadoLibre.

---

## ğŸ¯ Â¿QuÃ© Detecta?

### 1. **Duplicados por ASIN** âœ…
Si el mismo ASIN ya fue publicado, lo saltea automÃ¡ticamente.

**Ejemplo:**
- Procesaste `B0DJ19VGDD` (OrquÃ­dea LEGO)
- Lo intentÃ¡s publicar de nuevo
- âœ… Sistema lo detecta y lo omite

### 2. **Duplicados por GTIN/UPC** âœ…
Si otro ASIN tiene el mismo cÃ³digo de barras (mismo producto fÃ­sico), lo detecta.

**Ejemplo:**
- `B081SRSNWW`: Teclado Logitech K380 Negro (UPC: 097855143730)
- `B07VKPGC3M`: Teclado Logitech K380 Blanco (UPC: 097855143730)
- âš ï¸ Mismo UPC = mismo producto base, diferente color
- âœ… Sistema lo detecta y te avisa

---

## ğŸš€ Uso del Pipeline Inteligente

### OpciÃ³n A: Pipeline AutomÃ¡tico (Recomendado)

```bash
./venv/bin/python3 run_pipeline_smart.py
```

**Este script hace:**

1. Lee `asins.txt`
2. Verifica cada ASIN contra la base de datos
3. Filtra duplicados automÃ¡ticamente
4. Te muestra un resumen:
   ```
   ğŸ“Š RESUMEN
   Total ASINs: 100
   âœ… Nuevos: 87
   â­ï¸  Duplicados: 13
   ```
5. Te pregunta si querÃ©s continuar
6. Ejecuta el pipeline normal **solo con los productos nuevos**

**Ventajas:**
- Ahorra tiempo (no reprocesa productos ya publicados)
- Ahorra tokens de OpenAI (no consulta IA para productos duplicados)
- Evita errores de MercadoLibre por duplicados

### OpciÃ³n B: VerificaciÃ³n Manual

```bash
# Ver quÃ© ASINs son duplicados sin ejecutar nada
./venv/bin/python3 src/pipeline/duplicate_checker.py
```

Esto analiza los primeros 10 ASINs de `asins.txt` y te muestra cuÃ¡les son nuevos y cuÃ¡les duplicados.

---

## ğŸ“Š Verificar ASINs Publicados

```bash
# Ver todos los ASINs publicados
sqlite3 storage/listings_database.db "SELECT asin, item_id, title FROM listings ORDER BY date_published DESC LIMIT 20;"

# Contar productos publicados
sqlite3 storage/listings_database.db "SELECT COUNT(*) FROM listings WHERE item_id IS NOT NULL;"

# Ver productos publicados hoy
sqlite3 storage/listings_database.db "SELECT asin, title FROM listings WHERE date(date_published) = date('now');"
```

---

## ğŸ” CÃ³mo Funciona Internamente

### Base de Datos: `storage/listings_database.db`

Cada vez que publicÃ¡s un producto exitosamente, se guarda:

```
asin        â†’ B0DJ19VGDD
gtin        â†’ 5702017415482 (cÃ³digo de barras UPC/EAN)
item_id     â†’ CBT3008163812 (ID de MercadoLibre)
title       â†’ LEGO Botanicals OrquÃ­dea...
date_published â†’ 2025-11-08T13:04:19
```

### VerificaciÃ³n en 2 pasos:

1. **Check por ASIN**: `SELECT * FROM listings WHERE asin = 'B0DJ19VGDD'`
   - Si existe â†’ Duplicado exacto
   - Si no existe â†’ Continuar a paso 2

2. **Check por GTIN**: `SELECT * FROM listings WHERE gtin = '5702017415482'`
   - Si existe â†’ Mismo producto, ASIN diferente (variante/color/distribuidor)
   - Si no existe â†’ Producto nuevo âœ…

---

## ğŸ¬ Flujo Completo Recomendado

```bash
# 1. Buscar ASINs por keyword
./search_asins.sh "lego star wars" 500

# 2. Ejecutar pipeline inteligente (con detecciÃ³n de duplicados)
./venv/bin/python3 run_pipeline_smart.py

# Salida esperada:
# ğŸ“‚ LeÃ­dos 500 ASINs desde asins.txt
# ğŸ” Verificando 500 ASINs contra la base de datos...
#
# âœ… B0ABC123: Nuevo producto
# â­ï¸  B0DEF456: Ya publicado â†’ CBT3008123456
# âœ… B0GHI789: Nuevo producto
# ...
#
# ğŸ“Š RESUMEN
# Total ASINs: 500
# âœ… Nuevos: 437
# â­ï¸  Duplicados: 63
#
# Â¿QuerÃ©s continuar con el pipeline? [s/n]: s
#
# ğŸš€ INICIANDO PIPELINE COMPLETO
# [Procesa solo los 437 ASINs nuevos]
```

---

## ğŸ“ˆ Beneficios

**Antes (sin detecciÃ³n de duplicados):**
- 100 ASINs en `asins.txt`
- 30 ya publicados
- Pipeline procesa los 100 â†’ desperdicia ~15 minutos y tokens
- MercadoLibre rechaza los 30 duplicados â†’ errores innecesarios

**Ahora (con detecciÃ³n de duplicados):**
- 100 ASINs en `asins.txt`
- Sistema detecta 30 duplicados automÃ¡ticamente
- Pipeline procesa solo 70 ASINs nuevos â†’ ahorra ~15 minutos
- 0 errores por duplicados en MercadoLibre

**Ahorro estimado:**
- â±ï¸ Tiempo: ~30% menos
- ğŸ’° Tokens: ~30% menos
- âŒ Errores: ~90% menos

---

## âš™ï¸ ConfiguraciÃ³n Avanzada

### Deshabilitar verificaciÃ³n de duplicados (no recomendado)

Si por alguna razÃ³n querÃ©s procesar todos los ASINs sin filtrar:

```bash
# Usar el pipeline original sin verificaciÃ³n
./venv/bin/python3 src/integrations/mainglobal.py
```

### Limpiar base de datos (testing)

```bash
# âš ï¸ CUIDADO: Esto borra TODOS los registros
sqlite3 storage/listings_database.db "DELETE FROM listings;"
```

---

## ğŸ§ª Testing

### Probar con ASINs de prueba

```bash
# Crear archivo de prueba
echo "B0DJ19VGDD
B0NEW12345
B0ANOTHER1" > asins_test.txt

# Copiar temporalmente
cp asins.txt asins_backup.txt
cp asins_test.txt asins.txt

# Probar detecciÃ³n
./venv/bin/python3 src/pipeline/duplicate_checker.py

# Restaurar
mv asins_backup.txt asins.txt
```

---

## ğŸ“š Archivos del Sistema

```
src/
  pipeline/
    duplicate_checker.py          # Motor de detecciÃ³n de duplicados

scripts/
  tools/
    save_listing_data.py          # Funciones de BD (check_asin_exists, check_gtin_exists)

storage/
  listings_database.db            # Base de datos SQLite con todos los productos publicados

run_pipeline_smart.py             # Pipeline inteligente (wrapper recomendado)
```

---

## â“ FAQ

**Â¿QuÃ© pasa si borro `listings_database.db`?**

Se pierde el historial de productos publicados y el sistema no podrÃ¡ detectar duplicados. La BD se recrea automÃ¡ticamente vacÃ­a.

**Â¿Puedo editar la BD manualmente?**

SÃ­, es SQLite estÃ¡ndar. UsÃ¡ cualquier cliente SQL o `sqlite3` desde terminal.

**Â¿El GTIN siempre estÃ¡ disponible?**

No, algunos productos de Amazon no tienen GTIN. En ese caso solo se verifica por ASIN.

**Â¿QuÃ© pasa si cambio el precio de un producto ya publicado?**

El sistema de duplicados solo previene **crear nuevos listings**. Para actualizar precios de productos existentes, usÃ¡ el sistema de precios dinÃ¡micos (ver `PRECIOS_DINAMICOS.md`).

**Â¿Funciona para todos los marketplaces (MÃ©xico, Brasil, etc)?**

SÃ­, la detecciÃ³n es independiente del marketplace. Un producto publicado en MÃ©xico se detecta como duplicado aunque lo intentes publicar en Brasil.

---

ğŸ¤– Sistema automÃ¡tico de prevenciÃ³n de duplicados integrado al pipeline
