# ğŸ“š Sistema Completo Amazon â†’ MercadoLibre - ExplicaciÃ³n Detallada

## ğŸ¯ VisiÃ³n General

Este es un sistema automatizado completo que:
1. Obtiene productos de Amazon
2. Los transforma al formato de MercadoLibre
3. Los publica automÃ¡ticamente en 5 paÃ­ses
4. Sincroniza precios y stock continuamente
5. Responde preguntas de clientes automÃ¡ticamente
6. EnvÃ­a notificaciones de ventas y eventos

---

## ğŸ“¦ MÃ³dulos del Sistema

### 1ï¸âƒ£ PUBLICACIÃ“N AUTOMÃTICA (main2)

**Archivo**: `scripts/tools/main2.py`

**FunciÃ³n**: Publica productos de Amazon en MercadoLibre

**Proceso**:
```
1. Lee ASINs de Amazon desde asins.txt
2. Obtiene datos del producto (Amazon SP-API)
3. Transforma datos al formato MercadoLibre
4. Encuentra la categorÃ­a correcta con IA
5. Genera descripciÃ³n optimizada en espaÃ±ol
6. Crea imÃ¡genes con marca de agua
7. Publica en 5 paÃ­ses simultÃ¡neamente (BR, MX, CL, CO, UY)
8. Guarda en base de datos
```

**EjecuciÃ³n**:
```bash
# Manual
./venv/bin/python3 scripts/tools/main2.py

# Con ASINs especÃ­ficos
./venv/bin/python3 scripts/tools/main2.py B001 B002 B003
```

**CaracterÃ­sticas**:
- âœ… PublicaciÃ³n multi-paÃ­s automÃ¡tica
- âœ… CategorizaciÃ³n con IA (GPT-4)
- âœ… TraducciÃ³n automÃ¡tica al espaÃ±ol
- âœ… OptimizaciÃ³n de precios (markup 40%)
- âœ… ValidaciÃ³n de atributos obligatorios
- âœ… Manejo de errores y reintentos
- âœ… Notificaciones Telegram

---

### 2ï¸âƒ£ SINCRONIZACIÃ“N CONTINUA (sync_amazon_ml)

**Archivo**: `scripts/tools/sync_amazon_ml.py`
**Loop**: `scripts/tools/sync_amazon_ml_loop.sh`

**FunciÃ³n**: Mantiene MercadoLibre sincronizado con Amazon

**Proceso**:
```
Cada 6 horas:
1. Consulta todos los productos publicados (desde BD)
2. Para cada producto:
   a. Verifica estado en Amazon (disponibilidad y precio)
   b. Si precio cambiÃ³ â†’ Actualiza en ML
   c. Si sin stock â†’ Pausa en ML (stock=0)
   d. Si vuelve a estar disponible â†’ Reactiva (stock=10)
   e. Actualiza base de datos automÃ¡ticamente
3. EnvÃ­a notificaciones Telegram de cambios
```

**Iniciar**:
```bash
# Loop automÃ¡tico cada 6 horas
cd /Users/felipemelucci/Desktop/revancha
nohup ./scripts/tools/sync_amazon_ml_loop.sh > /dev/null 2>&1 &

# Ver log en tiempo real
tail -f logs/sync_amazon_ml_loop.log
```

**GestiÃ³n**:
```bash
# Ver si estÃ¡ corriendo
ps aux | grep sync_amazon_ml_loop.sh

# Detener
pkill -f sync_amazon_ml_loop.sh

# Ver cambios realizados
grep "Actualizado" logs/sync_amazon_ml.log
grep "pausado" logs/sync_amazon_ml.log
grep "reactivado" logs/sync_amazon_ml.log
```

**Operaciones clave**:

1. **Actualizar Precio**:
   - Usa `net_proceeds` (lo que recibe el vendedor)
   - ML agrega fees para precio final al cliente
   - Actualiza en 5 paÃ­ses simultÃ¡neamente
   - Guarda en BD automÃ¡ticamente

2. **Pausar Producto** (sin stock):
   - Pone `available_quantity: 0`
   - Producto visible pero "sin disponibilidad"
   - No se pueden hacer ventas
   - Guarda `stock=0` en BD

3. **Reactivar Producto**:
   - Pone `available_quantity: 10`
   - Producto disponible para compra
   - Guarda `stock=10` en BD

---

### 3ï¸âƒ£ AUTO-RESPUESTA DE PREGUNTAS

**Archivo**: `scripts/tools/auto_answer_questions.py`
**Loop**: `scripts/tools/auto_responder_loop.sh`

**FunciÃ³n**: Responde preguntas de clientes automÃ¡ticamente

**Proceso**:
```
Cada 1 minuto:
1. Obtiene preguntas sin responder de ML
2. Para cada pregunta:
   a. Verifica si hay template genÃ©rico â†’ Responde (0 tokens)
   b. Busca en cachÃ© respuestas similares â†’ Responde (0 tokens)
   c. Si no hay match â†’ Genera con IA (~150 tokens)
   d. Guarda respuesta en cachÃ© para futuro
3. Marca pregunta como respondida
```

**CaracterÃ­sticas**:
- âœ… 20+ templates genÃ©ricos (espaÃ±ol/inglÃ©s)
- âœ… CachÃ© inteligente de respuestas
- âœ… Respuestas personalizadas con IA cuando es necesario
- âœ… 95% de ahorro en tokens vs IA pura
- âœ… Respuestas en < 1 minuto

**Templates incluidos**:
- EnvÃ­o y tiempo de entrega
- GarantÃ­a y devoluciones
- Compatibilidad
- CaracterÃ­sticas tÃ©cnicas
- Disponibilidad de stock
- MÃ©todos de pago
- Colores y tamaÃ±os

---

### 4ï¸âƒ£ NOTIFICACIONES DE VENTAS

**Archivo**: `scripts/tools/telegram_sales_monitor.py`
**Loop**: `scripts/tools/sales_monitor_loop.sh`

**FunciÃ³n**: Notifica ventas en tiempo real por Telegram

**Proceso**:
```
Cada 5 minutos:
1. Consulta Ãºltimas Ã³rdenes en MercadoLibre
2. Verifica cuÃ¡les no han sido notificadas
3. Para cada venta nueva:
   a. Obtiene detalles del producto
   b. Calcula ganancia neta
   c. EnvÃ­a notificaciÃ³n a Telegram con emoji ğŸ’°
   d. Marca como notificada en BD
```

**NotificaciÃ³n incluye**:
- ğŸ›’ NÃºmero de orden
- ğŸ“¦ Producto vendido (tÃ­tulo y ASIN)
- ğŸ’° Precio de venta
- ğŸ’µ Ganancia neta (despuÃ©s de fees ML)
- ğŸ‘¤ Comprador
- ğŸŒ PaÃ­s
- ğŸ“… Fecha y hora

---

### 5ï¸âƒ£ BASE DE DATOS CENTRAL

**Archivo**: `storage/listings_database.db` (SQLite)

**Tablas**:

**`listings`** - Productos publicados:
```sql
- asin: ASIN de Amazon (PK)
- item_id: ID en MercadoLibre (CBT global)
- title: TÃ­tulo del producto
- price_usd: Precio en USD (net proceeds)
- stock: Cantidad disponible
- site_items: JSON con IDs por paÃ­s
- country: PaÃ­s principal
- category_id: CategorÃ­a ML
- date_created: Fecha publicaciÃ³n
- date_updated: Ãšltima actualizaciÃ³n
- status: Estado (active/paused)
```

**`questions_cache`** - CachÃ© de preguntas:
```sql
- question_text: Pregunta normalizada
- answer_text: Respuesta
- times_used: Veces reutilizada
- last_used: Ãšltima vez usada
```

**`sales_notifications`** - Control de notificaciones:
```sql
- order_id: ID de orden ML
- asin: Producto vendido
- notified_at: CuÃ¡ndo se notificÃ³
```

**Consultas Ãºtiles**:
```bash
# Ver todos los productos
sqlite3 storage/listings_database.db "SELECT asin, item_id, price_usd, stock FROM listings;"

# Productos pausados
sqlite3 storage/listings_database.db "SELECT * FROM listings WHERE stock = 0;"

# Productos activos
sqlite3 storage/listings_database.db "SELECT * FROM listings WHERE stock > 0;"

# Total de productos
sqlite3 storage/listings_database.db "SELECT COUNT(*) FROM listings;"

# Respuestas mÃ¡s usadas
sqlite3 storage/listings_database.db "SELECT question_text, times_used FROM questions_cache ORDER BY times_used DESC LIMIT 10;"
```

---

## ğŸ”„ Flujo Completo del Sistema

### Ciclo de Vida de un Producto:

```
1. PUBLICACIÃ“N (main2.py)
   â”œâ”€ Lee ASIN de asins.txt
   â”œâ”€ Obtiene datos de Amazon
   â”œâ”€ Transforma y optimiza
   â”œâ”€ Publica en ML (5 paÃ­ses)
   â””â”€ Guarda en BD

2. OPERACIÃ“N NORMAL
   â”œâ”€ Auto-responder contesta preguntas
   â”œâ”€ Sales monitor notifica ventas
   â””â”€ Producto disponible para compra

3. SINCRONIZACIÃ“N CONTINUA (cada 6 horas)
   â”œâ”€ Verifica precio en Amazon
   â”‚  â””â”€ Si cambiÃ³ â†’ Actualiza ML + BD
   â”œâ”€ Verifica disponibilidad
   â”‚  â”œâ”€ Sin stock â†’ Pausa (stock=0) + BD
   â”‚  â””â”€ Con stock â†’ Reactiva (stock=10) + BD
   â””â”€ EnvÃ­a notificaciones Telegram

4. GESTIÃ“N DE CLIENTES
   â”œâ”€ Cliente hace pregunta â†’ Auto-responder
   â”œâ”€ Cliente compra â†’ Sales monitor notifica
   â””â”€ BD actualizada en tiempo real
```

---

## âš™ï¸ ConfiguraciÃ³n (.env)

```bash
# === MERCADOLIBRE ===
ML_CLIENT_ID=...
ML_CLIENT_SECRET=...
ML_ACCESS_TOKEN=...
ML_REFRESH_TOKEN=...

# === AMAZON SP-API ===
LWA_CLIENT_ID=...
LWA_CLIENT_SECRET=...
REFRESH_TOKEN=...
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
MARKETPLACE_ID=ATVPDKIKX0DER
AMZ_ENDPOINT=https://sellingpartnerapi-na.amazon.com

# === OPENAI ===
OPENAI_API_KEY=...

# === PRECIOS ===
PRICE_MARKUP_PERCENT=40    # 40% ganancia
USE_NET_PROCEEDS=true

# === TELEGRAM NOTIFICACIONES ===
TELEGRAM_BOT_TOKEN=...
TELEGRAM_CHAT_ID=...
TELEGRAM_NOTIFICATIONS_ENABLED=true

# === TELEGRAM PUBLICACIONES ===
TELEGRAM_PUBLISHING_BOT_TOKEN=...
TELEGRAM_PUBLISHING_CHAT_ID=...
TELEGRAM_PUBLISHING_ENABLED=true
```

---

## ğŸš€ Inicio RÃ¡pido - Sistema Completo

### 1. Iniciar Auto-Responder
```bash
cd /Users/felipemelucci/Desktop/revancha
nohup ./scripts/tools/auto_responder_loop.sh > /dev/null 2>&1 &
```

### 2. Iniciar Monitor de Ventas
```bash
nohup ./scripts/tools/sales_monitor_loop.sh > /dev/null 2>&1 &
```

### 3. Iniciar SincronizaciÃ³n
```bash
nohup ./scripts/tools/sync_amazon_ml_loop.sh > /dev/null 2>&1 &
```

### 4. Verificar que todo estÃ¡ corriendo
```bash
ps aux | grep -E "auto_responder|sales_monitor|sync_amazon_ml" | grep -v grep
```

### 5. Monitorear logs
```bash
# Auto-responder
tail -f logs/auto_responder_loop.log

# Ventas
tail -f logs/sales_monitor_loop.log

# SincronizaciÃ³n
tail -f logs/sync_amazon_ml_loop.log
```

---

## ğŸ“Š Monitoreo y Mantenimiento

### Verificar Estado General
```bash
# Ver procesos activos
ps aux | grep -E "loop.sh" | grep -v grep

# Ver Ãºltimas ejecuciones
ls -lht logs/*.log | head -10

# Estado de BD
sqlite3 storage/listings_database.db "
SELECT
  COUNT(*) as total,
  SUM(CASE WHEN stock > 0 THEN 1 ELSE 0 END) as activos,
  SUM(CASE WHEN stock = 0 THEN 1 ELSE 0 END) as pausados
FROM listings;"
```

### Detener Todo
```bash
pkill -f "auto_responder_loop.sh"
pkill -f "sales_monitor_loop.sh"
pkill -f "sync_amazon_ml_loop.sh"
```

### Reiniciar Todo
```bash
# Detener
pkill -f "loop.sh"

# Iniciar
cd /Users/felipemelucci/Desktop/revancha
nohup ./scripts/tools/auto_responder_loop.sh > /dev/null 2>&1 &
nohup ./scripts/tools/sales_monitor_loop.sh > /dev/null 2>&1 &
nohup ./scripts/tools/sync_amazon_ml_loop.sh > /dev/null 2>&1 &

echo "âœ… Sistema reiniciado"
```

---

## ğŸ› ï¸ Troubleshooting

### Token expirado (401)
```bash
# Renovar token ML
./venv/bin/python3 /tmp/refresh_ml_token.py

# Actualizar .env con nuevos tokens
```

### BD no actualiza
```bash
# Verificar permisos
ls -la storage/listings_database.db

# Verificar integridad
sqlite3 storage/listings_database.db "PRAGMA integrity_check;"
```

### SincronizaciÃ³n no funciona
```bash
# Test manual
./venv/bin/python3 scripts/tools/sync_amazon_ml.py

# Ver errores
tail -100 logs/sync_amazon_ml.log | grep "ERROR"
```

### Auto-responder no responde
```bash
# Verificar preguntas pendientes
./venv/bin/python3 scripts/tools/auto_answer_questions.py

# Ver log
tail -50 logs/auto_responder.log
```

---

## ğŸ“ Estructura de Archivos

```
revancha/
â”œâ”€â”€ .env                              # ConfiguraciÃ³n
â”œâ”€â”€ asins.txt                         # ASINs para publicar
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ tools/
â”‚       â”œâ”€â”€ main2.py                  # Publicador principal
â”‚       â”œâ”€â”€ sync_amazon_ml.py         # SincronizaciÃ³n
â”‚       â”œâ”€â”€ sync_amazon_ml_loop.sh    # Loop sync (6h)
â”‚       â”œâ”€â”€ auto_answer_questions.py  # Auto-responder
â”‚       â”œâ”€â”€ auto_responder_loop.sh    # Loop respuestas (1min)
â”‚       â”œâ”€â”€ telegram_sales_monitor.py # Monitor ventas
â”‚       â””â”€â”€ sales_monitor_loop.sh     # Loop ventas (5min)
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ listings_database.db          # BD central
â”‚   â””â”€â”€ asins_json/                   # Cache productos Amazon
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ sync_amazon_ml_loop.log       # Log sincronizaciÃ³n
â”‚   â”œâ”€â”€ auto_responder_loop.log       # Log respuestas
â”‚   â””â”€â”€ sales_monitor_loop.log        # Log ventas
â””â”€â”€ docs/
    â”œâ”€â”€ SYNC_AUTOMATION_README.md     # Doc sincronizaciÃ³n
    â”œâ”€â”€ AUTO_ANSWER_SYSTEM_README.md  # Doc auto-responder
    â””â”€â”€ SISTEMA_COMPLETO_EXPLICACION.md  # Este archivo
```

---

## âœ… Checklist de Sistema Funcional

- âœ… main2 publica productos correctamente
- âœ… Productos se guardan en BD
- âœ… SincronizaciÃ³n actualiza precios automÃ¡ticamente
- âœ… SincronizaciÃ³n pausa/reactiva segÃºn stock Amazon
- âœ… BD se actualiza con cada cambio de precio/stock
- âœ… Auto-responder contesta preguntas
- âœ… Monitor notifica ventas en tiempo real
- âœ… Telegram envÃ­a notificaciones de eventos
- âœ… Logs registran todas las operaciones
- âœ… Sistema funciona 24/7 en loop

---

## ğŸ¯ PrÃ³ximos Pasos (Opcional)

1. **Migrar a VPS** - Para correr 24/7 sin depender de Mac local
2. **Agregar mÃ¡s ASINs** - Escalar a mÃ¡s productos
3. **Analytics Dashboard** - Panel web para ver mÃ©tricas
4. **Auto-restock** - Ordenar automÃ¡ticamente a proveedor cuando stock bajo
5. **Multi-cuenta** - Publicar en mÃºltiples cuentas ML para mayor volumen

---

## ğŸ“ Resumen Ejecutivo

**Sistema 100% automatizado que:**
- ğŸ¤– Publica productos de Amazon en MercadoLibre
- ğŸ”„ Sincroniza precios y stock continuamente
- ğŸ’¬ Responde preguntas de clientes automÃ¡ticamente
- ğŸ’° Notifica ventas en tiempo real
- ğŸ“Š Mantiene base de datos actualizada
- ğŸŒ Opera en 5 paÃ­ses simultÃ¡neamente

**Todo funciona sin intervenciÃ³n manual. Solo ejecutar los loops y dejar que el sistema trabaje.**

---

Ãšltima actualizaciÃ³n: 2025-11-08
