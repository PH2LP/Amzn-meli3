# üîî Sistema de Notificaciones de Ventas por Telegram

Sistema automatizado que te notifica inmediatamente cuando hay una venta en MercadoLibre, con toda la informaci√≥n necesaria para comprar el producto en Amazon.

---

## ‚ö° Inicio R√°pido

### 1. Crear Bot de Telegram

1. Abre Telegram y busca [@BotFather](https://t.me/BotFather)
2. Env√≠a el comando `/newbot`
3. Sigue las instrucciones para crear tu bot
4. Guarda el **token** que te da (ej: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 2. Obtener tu Chat ID

1. Busca [@userinfobot](https://t.me/userinfobot) en Telegram
2. Env√≠a `/start`
3. El bot te responder√° con tu **Chat ID** (ej: `987654321`)

### 3. Configurar Credenciales

Edita el archivo `.env` y agrega:

```bash
# Telegram
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_CHAT_ID=987654321
```

### 4. Ejecutar el Notificador

**Opci√≥n A: Ejecutar una vez (manual)**
```bash
python3 scripts/tools/telegram_sales_notifier.py
```

**Opci√≥n B: Ejecutar en loop continuo (recomendado)**
```bash
./scripts/tools/telegram_notifier_loop.sh
```

---

## üì± Formato de la Notificaci√≥n

Cuando hay una venta, recibir√°s un mensaje por Telegram con:

```
üéâ ¬°NUEVA VENTA EN MERCADOLIBRE! üéâ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì¶ PRODUCTO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ T√≠tulo: [Nombre del producto]
‚Ä¢ Marca: [Marca]
‚Ä¢ Modelo: [Modelo]
‚Ä¢ Cantidad: 1
‚Ä¢ Precio unitario: $XX.XX
‚Ä¢ Total: $XX.XX

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üõí COMPRAR EN AMAZON
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ ASIN: B0XXXXXXXXX
‚Ä¢ Link: [Comprar en Amazon]

‚ö†Ô∏è Comprar 1 unidad(es)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ COMPRADOR
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Usuario: [nickname]
‚Ä¢ Ubicaci√≥n: [Ciudad, Estado, Pa√≠s]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã ORDEN
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ ID Orden: 123456789
‚Ä¢ ID MercadoLibre: MLM123456789

üîó Link ML: [Ver publicaci√≥n]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ Proceder a comprar en Amazon y marcar como enviado en ML.
```

---

## üîÑ Flujo de Trabajo

1. **Cliente compra en MercadoLibre**
   - El sistema detecta la venta autom√°ticamente

2. **Recibes notificaci√≥n en Telegram**
   - Con link directo a Amazon
   - ASIN copiable
   - Cantidad exacta a comprar

3. **Compras en Amazon**
   - Haz clic en el link de Amazon
   - Compra la cantidad indicada
   - Env√≠a a la direcci√≥n del comprador

4. **Marcas como enviado en ML**
   - Entra a MercadoLibre
   - Marca la orden como enviada
   - Agrega tracking number de Amazon

---

## üîß Funcionalidades

### ‚úÖ Detecci√≥n Autom√°tica
- Revisa ventas cada 60 segundos
- Solo notifica ventas nuevas (no duplica)
- Filtra solo √≥rdenes pagadas/confirmadas

### ‚úÖ Informaci√≥n Completa
- Link directo a Amazon con ASIN
- Cantidad exacta a comprar
- Datos del comprador y ubicaci√≥n
- Links a publicaci√≥n de ML y orden

### ‚úÖ Registro de Notificaciones
- Guarda historial de ventas notificadas
- Previene notificaciones duplicadas
- Logs detallados en `storage/logs/sales/`

### ‚úÖ Formato Optimizado
- Mensaje HTML con formato bonito
- Links clicables
- ASINs copiables con un toque
- Emojis para mejor lectura

---

## üìä Monitoreo

### Ver logs en tiempo real

```bash
tail -f logs/telegram_notifier_loop.log
```

### Ver historial de ventas notificadas

```bash
cat storage/logs/sales_notified.json
```

### Ver estad√≠sticas de verificaci√≥n

```bash
ls -lh storage/logs/sales/
```

---

## ‚ö†Ô∏è Soluci√≥n de Problemas

### Error: "Missing Telegram credentials"

```bash
# Verifica que .env tenga las credenciales
grep TELEGRAM .env
```

Debe mostrar:
```
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_CHAT_ID=987654321
```

### Error: "Could not get user_id"

Verifica que el token de MercadoLibre est√© v√°lido:
```bash
python3 scripts/auth/refresh_ml_token.py
```

### No recibo notificaciones

1. **Verifica que el bot est√© corriendo:**
   ```bash
   ps aux | grep telegram_notifier
   ```

2. **Verifica que haya ventas pendientes:**
   ```bash
   python3 scripts/tools/telegram_sales_notifier.py
   ```

3. **Verifica que el bot de Telegram funcione:**
   - Env√≠a un mensaje a tu bot
   - Verifica que responda

### Bot no encuentra el ASIN

Esto significa que el producto vendido no est√° en la base de datos. Ejecuta:

```bash
python3 scripts/tools/save_listing_data.py
```

---

## üîê Seguridad

- El bot **SOLO** env√≠a mensajes a tu Chat ID configurado
- Las credenciales se guardan en `.env` (no compartir)
- Los tokens de Telegram no tienen acceso a otras funciones
- El sistema no almacena datos sensibles del comprador

---

## üöÄ Ejecuci√≥n en Producci√≥n

### Opci√≥n 1: Screen (recomendado)

```bash
# Crear sesi√≥n de screen
screen -S telegram_notifier

# Ejecutar el notificador
./scripts/tools/telegram_notifier_loop.sh

# Desconectar (Ctrl+A, luego D)
# El proceso sigue corriendo en background

# Reconectar despu√©s
screen -r telegram_notifier
```

### Opci√≥n 2: Cron Job

Ejecutar cada minuto:

```bash
crontab -e
```

Agregar:
```
* * * * * cd /ruta/a/revancha && ./venv/bin/python3 scripts/tools/telegram_sales_notifier.py >> logs/telegram_notifier_cron.log 2>&1
```

### Opci√≥n 3: Systemd Service (Linux)

Crear `/etc/systemd/system/telegram-notifier.service`:

```ini
[Unit]
Description=Telegram Sales Notifier
After=network.target

[Service]
Type=simple
User=tu_usuario
WorkingDirectory=/ruta/a/revancha
ExecStart=/ruta/a/revancha/scripts/tools/telegram_notifier_loop.sh
Restart=always

[Install]
WantedBy=multi-user.target
```

Habilitar:
```bash
sudo systemctl enable telegram-notifier
sudo systemctl start telegram-notifier
```

---

## üìù Configuraci√≥n Avanzada

### Cambiar intervalo de verificaci√≥n

Edita `scripts/tools/telegram_notifier_loop.sh`:

```bash
# Cambiar de 60 a 30 segundos
sleep 30
```

### Limitar √≥rdenes revisadas

Edita `scripts/tools/telegram_sales_notifier.py` l√≠nea 120:

```python
# Cambiar de 50 a 100 √≥rdenes
orders = get_ml_orders(user_id, limit=100)
```

### Notificar ventas antiguas

Elimina el archivo de ventas notificadas:

```bash
rm storage/logs/sales_notified.json
```

**‚ö†Ô∏è Cuidado:** Esto notificar√° TODAS las ventas existentes.

---

## üìû Soporte

- Ver logs: `logs/telegram_notifier_loop.log`
- Ver estad√≠sticas: `storage/logs/sales/`
- Consultar base de datos: `sqlite3 storage/listings_database.db`

---

**√öltima actualizaci√≥n:** Noviembre 2025
**Versi√≥n:** 1.0
