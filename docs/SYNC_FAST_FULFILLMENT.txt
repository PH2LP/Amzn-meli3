# üîÑ Sync con Fast Fulfillment Filter

## üìã Resumen

`sync_amazon_ml.py` **ya est√° usando el filtro de Fast Fulfillment autom√°ticamente** a trav√©s de `get_prime_offers_batch_optimized()`.

Cuando ejecutes sync, pausar√° autom√°ticamente productos que:
- ‚ùå Entren en backorder (>7 d√≠as)
- ‚ùå Tarden >24h en salir del almac√©n
- ‚ùå Pierdan Prime
- ‚ùå No tengan fecha de disponibilidad

---

## üîß C√≥mo Funciona

### Flujo de Sync:

```
1. Obtener listings de BD
   ‚Üì
2. get_prime_offers_batch_optimized(asins)  ‚Üê FILTRO APLICADO AQU√ç
   ‚Üì
3. Para cada listing:
   Si prime_offer = None:
     ‚Üí PAUSAR en ML (stock=0)
     ‚Üí Notificar por Telegram
   Si prime_offer != None:
     ‚Üí Actualizar precio si cambi√≥
     ‚Üí Mantener activo
```

---

## ‚úÖ Integraci√≥n Autom√°tica

### C√≥digo de sync (l√≠nea 637):
```python
prime_offer_cache = get_prime_offers_batch_optimized(asins, batch_size=20, show_progress=True)
```

### Esta funci√≥n YA incluye el filtro:
- ‚úÖ `availabilityType = "NOW"` + `maximumHours ‚â§ 24`
- ‚úÖ `availabilityType = "FUTURE_WITH_DATE"` + `d√≠as ‚â§ 7`
- ‚ùå Rechaza backorders largos
- ‚ùå Rechaza productos sin fecha

---

## üìä Casos de Uso

### Caso 1: Producto entra en backorder
```
Estado anterior:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ availabilityType: NOW
  ‚Ä¢ maximumHours: 0

Estado actual:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ availabilityType: FUTURE_WITH_DATE
  ‚Ä¢ availableDate: 2025-12-01 (18 d√≠as)

Acci√≥n de sync:
  ‚ùå PAUSA en MercadoLibre
  üì± Notificaci√≥n Telegram: "Pausado: Disponible en 18 d√≠as (>7d)"
  üìù Log: "Producto pausado - raz√≥n: backorder largo"
```

---

### Caso 2: Producto tarda en salir del almac√©n
```
Estado anterior:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ availabilityType: NOW
  ‚Ä¢ maximumHours: 0

Estado actual:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ availabilityType: NOW
  ‚Ä¢ maximumHours: 72

Acci√≥n de sync:
  ‚ùå PAUSA en MercadoLibre
  üì± Notificaci√≥n: "Pausado: MaxHours=72h (3.0d) >24h"
  üìù Log: "Producto pausado - raz√≥n: warehouse delay"
```

---

### Caso 3: Producto pierde Prime
```
Estado anterior:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ FBA: ‚úÖ

Estado actual:
  ‚Ä¢ Prime: ‚ùå
  ‚Ä¢ FBA: ‚ùå

Acci√≥n de sync:
  ‚ùå PAUSA en MercadoLibre
  üì± Notificaci√≥n: "Pausado: Sin oferta Prime activa"
  üìù Log: "Producto pausado - raz√≥n: no prime"
```

---

### Caso 4: Producto sigue disponible
```
Estado anterior:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ availabilityType: NOW
  ‚Ä¢ maximumHours: 0
  ‚Ä¢ Precio: $19.99

Estado actual:
  ‚Ä¢ Prime: ‚úÖ
  ‚Ä¢ availabilityType: NOW
  ‚Ä¢ maximumHours: 0
  ‚Ä¢ Precio: $21.99

Acci√≥n de sync:
  ‚úÖ MANTIENE ACTIVO en MercadoLibre
  üí∞ ACTUALIZA PRECIO: $19.99 ‚Üí $21.99
  üìù Log: "Precio actualizado exitosamente"
```

---

## üéØ Estad√≠sticas de Sync

Cuando ejecutes `sync_amazon_ml.py`, ver√°s:

```
üìä RESUMEN DE SINCRONIZACI√ìN
================================================================================
Total procesados:       150
Publicaciones pausadas: 23   ‚Üê Incluye productos sin fast fulfillment
Precios actualizados:   47
Sin cambios:            75
Errores:                5
```

**Razones de pausa incluir√°n:**
- "Pausado: Disponible en 18 d√≠as (>7d)"
- "Pausado: MaxHours=72h (3.0d) >24h"
- "Pausado: Sin fecha de disponibilidad (FUTURE_WITHOUT_DATE)"
- "Pausado: Sin oferta Prime activa"

---

## üìù Logs Detallados

### Ejemplo de producto pausado por backorder:
```
üîÑ Sincronizando: B0XXXXXX
   ML Item ID: CBT1234567890
   T√≠tulo: Producto Ejemplo...
   Precio actual ML: $29.99 USD
   üì° Verificando datos Prime (desde cache batch)...
   ‚ö†Ô∏è PRODUCTO RECHAZADO POR FILTROS
   üìã Raz√≥n: Disponible en 15 d√≠as (>7d)
   ‚è∏Ô∏è ACCI√ìN: Pausar publicaci√≥n
   üì¶ Poniendo stock en 0 (sin disponibilidad)...
   ‚úÖ Stock actualizado a 0 exitosamente
   ‚úÖ Publicaci√≥n pausada exitosamente
```

---

## üîß Configuraci√≥n

### Ajustar l√≠mites del filtro:

Si quieres cambiar los criterios, edita `src/integrations/amazon_pricing.py`:

```python
# L√≠neas 18-19
MAX_WAREHOUSE_HOURS = 24  # Cambiar a 12 (m√°s estricto) o 36 (m√°s flexible)
MAX_BACKORDER_DAYS = 7    # Cambiar a 3 (estricto) o 14 (flexible)
```

**Nota:** Cualquier cambio aqu√≠ afectar√° TANTO a `main2.py` como a `sync_amazon_ml.py`

---

## ‚è∞ Frecuencia de Ejecuci√≥n

### Cron Job actual:
```bash
0 9 */3 * * cd /path && ./venv/bin/python3 sync_amazon_ml.py >> logs/sync_amazon_ml.log 2>&1
```

**Ejecuta cada 3 d√≠as a las 9:00 AM**

### Si quieres mayor frecuencia:
```bash
# Cada 2 d√≠as
0 9 */2 * * cd /path && ./venv/bin/python3 sync_amazon_ml.py >> logs/sync_amazon_ml.log 2>&1

# Cada d√≠a
0 9 * * * cd /path && ./venv/bin/python3 sync_amazon_ml.py >> logs/sync_amazon_ml.log 2>&1

# Dos veces al d√≠a (9am y 9pm)
0 9,21 * * * cd /path && ./venv/bin/python3 sync_amazon_ml.py >> logs/sync_amazon_ml.log 2>&1
```

---

## üì± Notificaciones Telegram

### Mensajes que recibir√°s:

**Producto pausado:**
```
‚è∏Ô∏è CBT1234567890 ‚Üí B0XXXXXX
Pausado: Disponible en 18 d√≠as (>7d)

Producto Ejemplo...
```

**Precio actualizado:**
```
üí∞ CBT1234567890 ‚Üí B0XXXXXX
Precio: $29.99 ‚Üí $32.49 USD
Pa√≠ses: MLM, MLB, MLC

Producto Ejemplo...
```

---

## üß™ Testing

### Test manual:
```bash
python3 test_sync_fast_fulfillment.py
```

### Ejecuci√≥n de sync en producci√≥n:
```bash
# Ejecutar sync manualmente
python3 scripts/tools/sync_amazon_ml.py

# Ver logs en tiempo real
tail -f logs/sync_amazon_ml.log

# Ver √∫ltimo resultado JSON
cat logs/sync/sync_*.json | tail -1 | jq
```

---

## ‚ùì FAQ

**P: ¬øNecesito modificar sync_amazon_ml.py?**
R: No, ya est√° usando el filtro autom√°ticamente.

**P: ¬øQu√© pasa si un producto vuelve a estar disponible?**
R: En el pr√≥ximo sync, se reactivar√° autom√°ticamente (stock 0 ‚Üí 10).

**P: ¬øPuedo ver qu√© productos se pausaron?**
R: S√≠, en `logs/sync/sync_TIMESTAMP.json` hay un log completo.

**P: ¬øEl filtro afecta productos ya publicados?**
R: S√≠, sync verifica TODOS los productos publicados cada vez que se ejecuta.

**P: ¬øY si quiero que un producto espec√≠fico NO se pause?**
R: Actualmente no hay whitelist. Tendr√≠as que aumentar los l√≠mites globalmente o modificar el c√≥digo.

---

## ‚úÖ Checklist de Verificaci√≥n

- [x] sync usa `get_prime_offers_batch_optimized()`
- [x] Filtro fast fulfillment integrado
- [x] Mensajes de pausa mejorados con raz√≥n espec√≠fica
- [x] Notificaciones Telegram incluyen raz√≥n
- [x] Logs JSON incluyen informaci√≥n detallada
- [x] Tests pasando
- [x] Documentaci√≥n actualizada

---

## üéØ Resumen

‚úÖ **sync_amazon_ml.py ya est√° listo**

Cuando ejecutes sync:
- Pausar√° productos con backorder >7d
- Pausar√° productos con maxHours >24h
- Pausar√° productos sin Prime
- Mantendr√° activos solo productos con fast fulfillment
- Notificar√° por Telegram con razones claras

**No se requiere acci√≥n adicional** - el filtro ya est√° activo.
